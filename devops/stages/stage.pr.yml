stages:
  - stage: PR
    displayName: Pull Request Validation
    variables:
      - template: ../variables/variables.demo.yml
    jobs:
      - job: prValidation
        displayName: Code Validation and Formatting
        steps:
          - template: ../steps/step.init.yml
          - template: ../steps/step.validate.yml
          - template: ../steps/step.plan.yml
          - template: ../steps/step.infracost.yml

  - stage: Validation
    dependsOn: "PR"
    condition: Succeeded()
    displayName: "Approval or Reject"
    jobs:
      - job: waitForValidation
        displayName: "Wait for manual approval"
        pool: "server"
        timeoutInMinutes: "4320" # job times out in 3 days
        steps:
          - task: ManualValidation@0
            timeoutInMinutes: 1440 # task times out in 1 day
            inputs:
              notifyUsers: |
                cdaniel.oliveira@outlook.com
              instructions: "There are resources being destroyed as part of this deployment, please review the output of Terraform plan before approving."
              onTimeout: "reject"